
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>7. Lab 4: Mapping and Navigation &#8212; COMP3631 Website</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=605502e1" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509" />
  <script src="_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=bd9e20870c6007c4c509"></script>

    <script src="_static/documentation_options.js?v=296c0a1b"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'lab4';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="8. Lab 5: Computer Vision: Processing robot’s camera view" href="lab5.html" />
    <link rel="prev" title="6. Lab 3: Actuating the turtlebot in simulation" href="lab3.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <header>
  
    <div class="bd-header navbar navbar-expand-lg bd-navbar">
    </div>
  
  </header>

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/comp3631-logo-large-title.png" class="logo__image only-light" alt="COMP3631 Website - Home"/>
    <script>document.write(`<img src="_static/comp3631-logo-large-title.png" class="logo__image only-dark" alt="COMP3631 Website - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    COMP3631 Lab Worksheets
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="teaching-assistants.html">1. Teaching/Lab Assistants</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">2. Frequently Asked Questions (FAQ) and Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab1.html">3. Lab 1.1: Setting up your environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab1-optional.html">4. Lab 1.2: Learn about the command line interface and Git/GitHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab2.html">5. Lab 2: Writing a Talker and Listener</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab3.html">6. Lab 3: Actuating the turtlebot in simulation</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">7. Lab 4: Mapping and Navigation</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab5.html">8. Lab 5: Computer Vision: Processing robot’s camera view</a></li>
<li class="toctree-l1"><a class="reference internal" href="using_the_real_robot.html">9. How to use the real-robot</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab6.html">10. Lab 6: Real-robot lab</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">



<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Lab 4: Mapping and Navigation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#worksheet-objective">7.1. Worksheet Objective</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">7.2. Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mapping">7.3. Mapping</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#autonomous-navigation">7.4. Autonomous Navigation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#submission-instructions">7.5. Submission instructions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#remarks-and-checklist">7.6. Remarks and Checklist</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="lab-4-mapping-and-navigation">
<h1><span class="section-number">7. </span>Lab 4: Mapping and Navigation<a class="headerlink" href="#lab-4-mapping-and-navigation" title="Link to this heading">#</a></h1>
<!-- **Worksheet Contact:** Rafael Papallas (r.papallas@leeds.ac.uk) -->
<p><strong>Worksheet Contact:</strong> Xiao Wang (<a class="reference external" href="mailto:x&#46;wang16&#37;&#52;&#48;leeds&#46;ac&#46;uk">x<span>&#46;</span>wang16<span>&#64;</span>leeds<span>&#46;</span>ac<span>&#46;</span>uk</a>)</p>
<p>Please aim to complete this worksheet during week 5. The labs scheduled in week
5 will offer support and guidance for this worksheet.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Access lab4 files - Instructions</strong></p>
<p>To access the lab4 files, you need to click on this url
<a class="reference external" href="https://classroom.github.com/a/xke05n9w">classroom.github.com/a/xke05n9w</a>,
login to your
GitHub account and click the button to accept the lab4 assignment.</p>
<p>As always, before you start running any commands or code for this worksheet,
make sure <a class="reference internal" href="lab1.html#singularity-command"><span class="std std-ref">you are in a Singularity environment</span></a>.</p>
<p>Then execute the following commands:</p>
<ul class="simple">
<li><p>In a terminal, go to <code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">~/ros2_ws/src</span></code>.</p></li>
<li><p>Run: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">git&#64;github.com:COMP3631/lab4-YOUR_GITHUB_USERNAME</span> <span class="pre">lab4</span></code></p>
<ul>
<li><p>Note the ” lab4” at the end of the the compand: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">[...]</span> <span class="pre">lab4</span></code>.</p></li>
</ul>
</li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">$HOME/ros2_ws</span></code> and then <code class="docutils literal notranslate"><span class="pre">colcon</span> <span class="pre">build</span></code> to build the new package.</p></li>
</ul>
</div>
<section id="worksheet-objective">
<h2><span class="section-number">7.1. </span>Worksheet Objective<a class="headerlink" href="#worksheet-objective" title="Link to this heading">#</a></h2>
<p>Thus far, you have developed the skills necessary to work with ROS,
publishing/subscribing to topics and drive the robot’s base in Gazebo. In this
worksheet, you will learn how to create a map of a known environment and
leverage it to navigate the robot within that space collision-free.</p>
</section>
<section id="introduction">
<h2><span class="section-number">7.2. </span>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>The TurtleBot is equipped with ROS software, facilitating collision-path planning
within a known environment. The process is two-fold:</p>
<ol class="arabic simple">
<li><p><strong>Mapping:</strong> A map of the environment is needed for a motion planner:</p>
<ul class="simple">
<li><p>You tele-operate the robot (using the keyboard or a joystick) in the
environment. While you do this, the robot uses its sensor to create a
map.</p></li>
<li><p>You save this map to a file.</p></li>
<li><p>After this point, as long as the
environment does not change (i.e. the obstacles do not move significantly)
the robot can use this map for navigating autonomously in the environment.
If the environment changes significantly, you will need to re-map.</p></li>
</ul>
</li>
<li><p><strong>Navigation:</strong> The robot navigates autonomously using the existing map.</p>
<ul class="simple">
<li><p>You can give a goal pose to the robot, and it can plan a collision-free
path and then follow the path.</p></li>
<li><p>To know where it is in the environment, the robot uses its sensor for
localisation too.</p></li>
</ul>
</li>
</ol>
<p>The objective of this lab is to familiarise you with the mapping
and navigation software on the TurtleBot.
Many of the functionality you will use in this lab comes from the
<code class="docutils literal notranslate"><span class="pre">turtlebot3_cartographer</span></code> and <code class="docutils literal notranslate"><span class="pre">turtlebot3_navigation2</span></code> packages. You can find
a wiki page <a class="reference external" href="https://google-cartographer-ros-for-turtlebots.readthedocs.io/en/latest/">here</a>.</p>
<div class="docutils">
<h4 class="rubric" id="launch-gazebo-with-a-new-world-file">Launch Gazebo with a new world file</h4>
</div>
<p>Start the Turtlebot simulation with the house world. To do this, execute
in a terminal window:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ros2</span> <span class="n">launch</span> <span class="n">turtlebot3_gazebo</span> <span class="n">turtlebot3_house</span><span class="o">.</span><span class="n">launch</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>The first time you launch the new world, Gazebo may take a few
minutes to load. Please be patient.
A new world should launch that looks like the one below.</p>
<p>Typically, the robot starts outside the house; therefore, you
will need to move it inside. Please follow the steps
outlined in the following image:</p>
<figure class="align-default" id="id1">
<img alt="_images/lab5-initial-robot-pose.png" src="_images/lab5-initial-robot-pose.png" />
<figcaption>
<p><span class="caption-text">You need to move the robot in the house first so we can map the house.</span><a class="headerlink" href="#id1" title="Link to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="mapping">
<h2><span class="section-number">7.3. </span>Mapping<a class="headerlink" href="#mapping" title="Link to this heading">#</a></h2>
<p>Let’s start with mapping the new environment. In a new terminal run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ros2</span> <span class="n">launch</span> <span class="n">turtlebot3_cartographer</span> <span class="n">cartographer</span><span class="o">.</span><span class="n">launch</span><span class="o">.</span><span class="n">py</span> <span class="n">use_sim_time</span><span class="o">:=</span><span class="kc">True</span>
</pre></div>
</div>
<p>The launch file above initiates not only the mapping software but
also Rviz, a visualisation tool that displays the map as it is being
built. In Rviz, the areas of the map that have already been built are
indicated in red. At this point, you should see a similar screen with the one
below:</p>
<figure class="align-default" id="id2">
<img alt="_images/lab5-rviz.png" src="_images/lab5-rviz.png" />
<figcaption>
<p><span class="caption-text">Screenshot of Rviz when initially starts. The red part is the map being built so far.</span><a class="headerlink" href="#id2" title="Link to this image">#</a></p>
</figcaption>
</figure>
<div class="docutils">
<h4 class="rubric" id="tele-operating-the-turtlebot">Tele-operating the TurtleBot</h4>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can utilise the identical program for tele-operating both the simulated and
the real TurtleBot. This is feasible because both the simulated and actual
TurtleBots receive the same messages to the same topics. Therefore, the
tele-operation software is agnostic to whether it is interacting with the real
or the simulated robot; this seamless integration is made possible by the
abstraction capabilities of ROS.</p>
</div>
<p>To map the environment you need to move the robot around. The <code class="docutils literal notranslate"><span class="pre">turtlebot3_teleop</span></code>
package is used to tele-operate the TurtleBot. We will use the keyboard for
teleoperation. In a new terminal window run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ros2</span> <span class="n">run</span> <span class="n">turtlebot3_teleop</span> <span class="n">teleop_keyboard</span>
</pre></div>
</div>
<p>Pay attention to the instructions displayed on the screen regarding the
movement of the robot. It’s important not to hold the keys down continuously.
In brief:</p>
<ul class="simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">w</span></code> to increase and <code class="docutils literal notranslate"><span class="pre">x</span></code> to decrease linear velocity. Remember not to keep these keys pressed.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">a</span></code> to increase and <code class="docutils literal notranslate"><span class="pre">d</span></code> to decrease angular velocity (spin). Again, do not hold these keys down.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">s</span></code> or the space bar to bring the robot to stop.</p></li>
</ul>
<div class="docutils">
<h4 class="rubric" id="exercise-1-build-your-own-map-of-the-environment">Exercise 1: Build your own map of the environment</h4>
</div>
<p>To create a map of the environment, you’ll need to move the robot around
using the method described above.</p>
<p>You can track this process in Rviz. This is a process that can take 10+
minutes for you to complete. You need to make sure your robot sees all edges, corners, and
obstacles in the environment. You should make a few rounds in the environment
so that the robot collects as much information as possible. As this is a big
environment, you may focus on mapping only two rooms instead of the full house.
Of course, you are welcome to map the entire house.</p>
<p>Here are some tips and tricks for better mapping:</p>
<ol class="arabic simple">
<li><p>Avoid colliding with any obstacles or walls while driving the robot. Such
collisions can alter the environment’s layout and potentially render your
map inaccurate.</p></li>
<li><p>Move the robot at a slow pace. Rapid movement tends to yield less reliable
results.</p></li>
<li><p>Direct the robot towards interesting features within the room. By
‘interesting,’ we refer to features that are not symmetric or too common,
like unique obstacles. For instance, a flat wall mirrored on the opposite
end of the room won’t provide much valuable information. Seek out areas with
obstacles and non-symmetric characteristics.</p></li>
<li><p>When near such interesting features, pause and slowly rotate the robot
around that spot 2-3 times.</p></li>
<li><p>If you notice any inaccuracies in a specific region, revisit that area with
the robot, move more slowly, and rotate around the region to enhance the
map’s accuracy.</p></li>
</ol>
<p>Please note that the map will never be perfect.</p>
<div class="docutils">
<h5 class="rubric" id="how-good-should-my-map-be">How good should my map be?</h5>
</div>
<p>A good map doesn’t have to be perfect. Take the example map provided
below as a reference. The key aspect of a good map is to accurately represent
obstacles and clearly delineate openings between rooms and doors. Any black
marks on the map are interpreted as obstacles, and the robot is programmed not
to cross these areas. These could represent walls, bins, or any other form of
obstruction.</p>
<figure class="align-default" id="id3">
<img alt="_images/lab5-good-example-map.png" src="_images/lab5-good-example-map.png" />
<figcaption>
<p><span class="caption-text">Here is an example of a good map</span><a class="headerlink" href="#id3" title="Link to this image">#</a></p>
</figcaption>
</figure>
<div class="docutils">
<h5 class="rubric" id="saving-your-map-to-a-file">Saving your map to a file</h5>
</div>
<p>Once you’re satisfied with the map in Rviz, the next step is to save
this map to a file. For this purpose, you should execute the following command
in a separate terminal window:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ros2 run nav2_map_server map_saver_cli -f $HOME/ros2_ws/src/lab4/maps/mymap
</pre></div>
</div>
<p>Upon successfully saving the map, you should find two files located in the
<code class="docutils literal notranslate"><span class="pre">$HOME/ros2_ws/src/lab3/maps</span></code> directory: <code class="docutils literal notranslate"><span class="pre">mymap.pgm</span></code> and <code class="docutils literal notranslate"><span class="pre">mymap.yaml</span></code>. The
<code class="docutils literal notranslate"><span class="pre">.pgm</span></code> file is the actual map, which you can view as an image. The <code class="docutils literal notranslate"><span class="pre">.yaml</span></code> file
contains meta-data about your map.</p>
<p>Congratulations on creating a map of the environment! This map is
now ready for use in autonomous navigation, and you won’t need to repeat this
process for the current environment unless there are significant changes.</p>
<p>At this point, you can safely shut down (using <code class="docutils literal notranslate"><span class="pre">ctrl-c</span></code>) both the mapping and
the teleoperation processes.</p>
<p>If your map doesn’t turn out as expected, you can always use the provided
example map files: <code class="docutils literal notranslate"><span class="pre">examplemap.yaml</span></code> and <code class="docutils literal notranslate"><span class="pre">examplemap.pgm</span></code>. However, it’s highly
recommended to practice and learn how to create a map yourself, as this skill
will be essential when working with the real robot and for your group project.</p>
</section>
<section id="autonomous-navigation">
<h2><span class="section-number">7.4. </span>Autonomous Navigation<a class="headerlink" href="#autonomous-navigation" title="Link to this heading">#</a></h2>
<p>Now that you have successfully constructed a map, the next step is to enable
the robot to navigate autonomously within its environment.</p>
<p>Remember that, when you use the autonomous navigation stack, to kill the
tele-operation node as it can interfere with the navigation node.</p>
<p>To initiate the autonomous navigation, execute the following command in a new terminal
window, ensuring that you replace the placeholder path to a map file
with the actual path to your map file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ros2 launch turtlebot3_navigation2 navigation2.launch.py use_sim_time:=True map:=$HOME/ros2_ws/src/lab4/maps/mymap.yaml
</pre></div>
</div>
<p>This should start the navigation stack along with Rviz.
Once you have Rviz opened, you should see the map loaded into it.</p>
<div class="docutils">
<h4 class="rubric" id="letting-the-robot-know-roughly-its-initial-pose">Letting the robot know (roughly) its initial pose</h4>
</div>
<p>At this stage, it’s necessary to <strong>localise</strong> the robot within the map to give it
an approximate starting point. Observe the robot’s location in Gazebo, paying
attention to the direction is pointing to. Then, in Rviz, select the ‘2D Pose
Estimate’ button. Next, click and hold on the map at the robot’s location and
use the mouse to orient the robot in the correct direction. This step is
important as it helps the robot localise itself in the map. You don’t have to
be perfect, but roughly right. Refer to the image below for a visual guide on
how to perform this action:</p>
<figure class="align-default" id="id4">
<img alt="_images/lab5-pose-estimate.gif" src="_images/lab5-pose-estimate.gif" />
<figcaption>
<p><span class="caption-text">Use the “2D Pose Estimate” tool. Click on the point in
the map where the robot is located. A green arrow will appear. Keep the mouse
clicked and move the mouse to set the direction the robot is facing. Once you
have aligned the arrow with the robot’s orientation, release the mouse.</span><a class="headerlink" href="#id4" title="Link to this image">#</a></p>
</figcaption>
</figure>
<div class="docutils">
<h4 class="rubric" id="sending-navigation-goals-to-the-robot-through-rviz">Sending navigation goals to the robot through Rviz</h4>
</div>
<p>You are now ready to send navigation goals to the TurtleBot. To do this, use
the ‘2D Nav Goal’ button in Rviz. After clicking this button, select a point on
the map where you want the robot to go, and specify the direction you want it
to face upon arrival. You do this by clicking and holding at the chosen point,
then dragging the mouse to set the desired direction. Once you release the
mouse, the robot will begin navigating towards the set goal, while
avoiding obstacles along its path. For a visual demonstration of how to set a
navigation goal, refer to the image below:</p>
<figure class="align-default" id="id5">
<img alt="_images/lab5-nav-goal.gif" src="_images/lab5-nav-goal.gif" />
<figcaption>
<p><span class="caption-text">Set navigation goals to robot using the “Nav2Goal” button. Again,
click and hold to define the orientation.</span><a class="headerlink" href="#id5" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Congratulations! Your robot is autonomously navigating now.</p>
<div class="docutils">
<h4 class="rubric" id="sending-navigation-goals-to-the-robot-using-a-python-script">Sending navigation goals to the robot using a Python script</h4>
</div>
<p>Navigating the TurtleBot using the RViz window, as previously discussed, is one
approach. However, you also have the option to command your TurtleBot
programmatically using Python. Within your <code class="docutils literal notranslate"><span class="pre">ros2_ws/src/lab4/lab4</span></code> directory,
there’s a script named <code class="docutils literal notranslate"><span class="pre">go_to_specific_point_on_map.py</span></code>. Please open this
script.</p>
<p>Please briefly review to understand the script. To assist with
this, let’s examine some key sections of the script together, starting with the
code in the <code class="docutils literal notranslate"><span class="pre">main</span></code> function.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="n">go_to_pose</span> <span class="o">=</span> <span class="n">GoToPose</span><span class="p">()</span>
<span class="linenos">2</span><span class="n">go_to_pose</span><span class="o">.</span><span class="n">send_goal</span><span class="p">(</span><span class="mf">5.55</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.71</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>  <span class="c1"># example coordinates</span>
<span class="linenos">3</span><span class="n">rclpy</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">go_to_pose</span><span class="p">)</span>
</pre></div>
</div>
<p>This creates a <code class="docutils literal notranslate"><span class="pre">GoToPose</span></code> node (a class we define), and then using the <code class="docutils literal notranslate"><span class="pre">send_goal</span></code>
method we command the robot to go to <code class="docutils literal notranslate"><span class="pre">x=5.55,</span> <span class="pre">y=-3.71,</span> <span class="pre">theta=0.0</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Actions in ROS are alternatives to ROS services and we will introduce them at a
later robotics lecture when we go through advanced ROS features. For now,
actions are similar to ROS Servives in that you send a request and you get a
response, but they offer more capabilities and are appropriate for complex
tasks that can take a while to complete, like motion planning.</p>
</div>
<p>If you look at the <code class="docutils literal notranslate"><span class="pre">GoToPose</span></code> class, we employ the action communication type of
ROS to send a navigation goal. In the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> of the class we have:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="bp">self</span><span class="o">.</span><span class="n">action_client</span> <span class="o">=</span> <span class="n">ActionClient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">NavigateToPose</span><span class="p">,</span> <span class="s1">&#39;navigate_to_pose&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This is where we create a client for the action, sending <code class="docutils literal notranslate"><span class="pre">NavigateToPose</span></code> goals,
to the <code class="docutils literal notranslate"><span class="pre">navigate_to_pose</span></code> action.</p>
<p>Then, in the <code class="docutils literal notranslate"><span class="pre">send_goal</span></code> method we have:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="c1"># Position</span>
<span class="linenos">2</span><span class="n">goal_msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
<span class="linenos">3</span><span class="n">goal_msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
<span class="linenos">4</span>
<span class="linenos">5</span><span class="c1"># Orientation</span>
<span class="linenos">6</span><span class="n">goal_msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">yaw</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="linenos">7</span><span class="n">goal_msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">yaw</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>That’s where we set the desired goal, position and orientation for the action
message we will send. For orientation, we convert an Euler angle to a
quaternion representation. This conversion is important because while Euler
angles are more intuitive for humans to understand and define (using yaw,
pitch, and roll), the ROS navigation stack requires the orientation to be
specified in quaternions, which are better suited for 3D rotation without
suffering from issues like gimbal lock. The quaternion representation provides
a more robust and mathematically sound way to handle the robot’s orientation in
three-dimensional space.</p>
<p>Then we send the goal here:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="bp">self</span><span class="o">.</span><span class="n">send_goal_future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_client</span><span class="o">.</span><span class="n">send_goal_async</span><span class="p">(</span><span class="n">goal_msg</span><span class="p">,</span> <span class="n">feedback_callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feedback_callback</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that we also have <code class="docutils literal notranslate"><span class="pre">goal_response_callback</span></code>, <code class="docutils literal notranslate"><span class="pre">get_result_callback</span></code>, and
<code class="docutils literal notranslate"><span class="pre">feedback_callback</span></code> methods for the action. These are <em>asynchronous</em> methods which
are executed in the “background” providing useful information about the progress
of the action. In the future you may find them useful to implement complex planning
processes.</p>
<div class="docutils">
<h4 class="rubric" id="how-to-find-the-coordinate-in-the-map">How to find the coordinate in the map?</h4>
</div>
<p>To determine the <span class="math notranslate nohighlight">\(x\)</span>, <span class="math notranslate nohighlight">\(y\)</span> coordinates of a specific point you wish to navigate
to, use the “Publish Point” feature in RViz. First, select the “Publish Point”
option from the top menu in RViz. Then, hover your mouse over the desired
location on the map within RViz. As you move your cursor across the map, RViz
will display the coordinates (<span class="math notranslate nohighlight">\(x\)</span>, <span class="math notranslate nohighlight">\(y\)</span>, <span class="math notranslate nohighlight">\(z\)</span>) of the point under your mouse in
the lower-left corner of the RViz window. This tool is particularly useful for
pinpointing precise locations on the map for navigation purposes. An example of
this process can be seen in the image provided below:</p>
<figure class="align-default">
<img alt="_images/lab5-point.png" src="_images/lab5-point.png" />
</figure>
<div class="docutils">
<h4 class="rubric" id="exercise-2-now-your-turn-find-a-new-x-y-coordinate-to-move-the-robot-to">Exercise 2: Now your turn, find a new x, y coordinate to move the robot to</h4>
</div>
<p>Using this method, you can determine the <span class="math notranslate nohighlight">\(x\)</span>, <span class="math notranslate nohighlight">\(y\)</span> coordinate you want to specify in
the script.
Go ahead and find a new coordinate to command the robot to move to.
First try setting theta to zero (0) to determine which direction in
your map corresponds to zero rotation. Then you can change theta as you wish.
Modify the Python script to inject your new coordinate. Don’t forget to run
<code class="docutils literal notranslate"><span class="pre">colcon</span> <span class="pre">build</span></code> under <code class="docutils literal notranslate"><span class="pre">~/ros2_ws/</span></code> after your changes.</p>
<p>Execute the script and your robot should plan and move to the goal you specify:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ros2</span> <span class="n">run</span> <span class="n">lab4</span> <span class="n">go_to_pose</span>
</pre></div>
</div>
</section>
<section id="submission-instructions">
<h2><span class="section-number">7.5. </span>Submission instructions<a class="headerlink" href="#submission-instructions" title="Link to this heading">#</a></h2>
<p>When you think you have completed this worksheet, add, commit, and push your
new files (your map’s pgm and yaml files, as well as the changed
<code class="docutils literal notranslate"><span class="pre">go_to_specific_point_on_map.py</span></code> script, and any other related files you might
have created) and changes to the git repository with the correct git message
“Lab4 completed.”:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>cd $HOME/ros2_ws/src/lab4
git add .
git commit -m &quot;Lab4 completed.&quot;
git push
</pre></div>
</div>
</section>
<section id="remarks-and-checklist">
<h2><span class="section-number">7.6. </span>Remarks and Checklist<a class="headerlink" href="#remarks-and-checklist" title="Link to this heading">#</a></h2>
<p>As you conclude this worksheet, you have now developed all the necessary skills
to work on the project in a simulated environment. Next week you
will have the opportunity to apply these skills to a real robot! Yay!</p>
<p>Please check, by the end of this worksheet, that …</p>
<ul class="simple">
<li><p>You understand the difference between mapping and navigation.</p></li>
<li><p>You know how to generate a map using the ROS tools.</p></li>
<li><p>You know how to set initial estimate of the robot’s pose in the map.</p></li>
<li><p>You know how to use the map to send navigation goals to the robot through RViz.</p></li>
<li><p>You know how to use the map to send navigation goals to the robot through Python code.</p></li>
<li><p>You completed successfully the exercise of generating a map and modifying the Python script to move to a new goal.</p></li>
<li><p>You pushed your files to GitHub.</p></li>
</ul>
<p>If you have any questions or problems, please kindly ask one of the Teaching
Assistants of the module for help during the lab hours, or contact me.</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="lab3.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">6. </span>Lab 3: Actuating the turtlebot in simulation</p>
      </div>
    </a>
    <a class="right-next"
       href="lab5.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">8. </span>Lab 5: Computer Vision: Processing robot’s camera view</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#worksheet-objective">7.1. Worksheet Objective</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">7.2. Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mapping">7.3. Mapping</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#autonomous-navigation">7.4. Autonomous Navigation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#submission-instructions">7.5. Submission instructions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#remarks-and-checklist">7.6. Remarks and Checklist</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Rafael Papallas, Andy Bulpitt and Duygu Sarikaya
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024, Rafael Papallas, Andy Bulpitt and Duygu Sarikaya.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>